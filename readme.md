# iCSS--!：，interestingcss
## 1231231412
### 1231231412
- AAAAA
- BBBBB

- BBBBB

本系列围绕 `CSS` 展开，谈一些有趣的话题，内容天马行空，想到什么说什么，不仅是为了拓宽解决问题的思路，更涉及一些容易忽视或是十分有趣的 CSS 细节。

持续更新中，觉得不错的可以点个 `star` 订阅收藏。

所有文章都在 Issues 中，同步更新到我的个人博客，也可以点击下面链接进行跳转。

## Blog

本 `CSS` 系列同步更新在我的博客：

[CSS进阶系列](http://www.cnblogs.com/coco1s/category/833837.html)

## List

#### 1、[下面这个左边竖条图形，只使用一个标签，可以有多少种实现方式：](https://github.com/chokcoco/iCSS/issues/1)

![border](http://images.cnblogs.com/cnblogs_com/coco1s/881614/o_border.png)

123


<p><img src="http://images.cnblogs.com/cnblogs_com/coco1s/881614/o_border.png" /></p>

#### 2、[类似下面这样的条纹边框，只使用一个标签，可以有多少种实现方式 -- 从条纹边框的实现谈盒子模型：](https://github.com/chokcoco/iCSS/issues/1)

![backgroundClip](http://images.cnblogs.com/cnblogs_com/coco1s/881614/o_backgroundClip.png)

#### 3、[层叠顺序（stacking level）与堆栈上下文（stacking context）知多少？](https://github.com/chokcoco/iCSS/issues/1)

#### 4、[从倒影说起，谈谈 CSS 继承 inherit](https://github.com/chokcoco/iCSS/issues/1)

#### 5、[纯 CSS 实现单行居中显示文字，多行居左显示，最多两行超过用省略号结尾](https://github.com/chokcoco/iCSS/issues/1)

![多行文字展示](http://images.cnblogs.com/cnblogs_com/coco1s/881614/o_center.png)

#### 6、[全兼容的多列均匀布局问题](https://github.com/chokcoco/iCSS/issues/2)

如何实现下列这种多列均匀布局：

![多列均匀布局](http://images2015.cnblogs.com/blog/608782/201607/608782-20160713180644092-236763328.png)

#### 7、[全兼容的最后一条边界线问题](https://github.com/chokcoco/iCSS/issues/2)

看看下图，常见于一些导航栏中，要求每行中最后一列的右边框消失，如何在所有浏览器中最便捷最优雅的实现？

![消失的边界线](http://images.cnblogs.com/cnblogs_com/coco1s/881614/o_disappear.png)

#### 8、[纯CSS的导航栏Tab切换方案](https://github.com/chokcoco/iCSS/issues/2)

不用 `Javascript`，使用纯 `CSS` 方案，实现类似下图的导航栏 Tab 切换：

![纯CSS的导航栏切换方案](http://images2015.cnblogs.com/blog/608782/201610/608782-20161013103036328-1395095905.gif)

#### 9、[巧妙的多列等高布局](https://github.com/chokcoco/iCSS/issues/2)

规定下面的布局，实现多列等高布局，要求两列背景色等高。

``` HTML
<div class="container">
    <div class="left">多列等高布局左</div> 
    <div class="right">多列等高布局右</div>
</div>
```

#### 10、[巧妙的实现 CSS 斜线](https://github.com/chokcoco/iCSS/issues/2)

使用单个标签，如何实现下图所示的斜线效果:

![CSS slash](http://images2015.cnblogs.com/blog/608782/201611/608782-20161103132531986-482520887.png)

#### 11、[IFC、BFC、GFC 与 FFC 知多少](https://github.com/chokcoco/iCSS/issues/5)

#### 12、[结构性伪类选择器](https://github.com/chokcoco/iCSS/issues/5)

#### 13、[引人瞩目的 CSS 变量（Variable）](https://github.com/chokcoco/iCSS/issues/5)

#### 14、[CSS命名方式是否有必要规范](https://github.com/chokcoco/iCSS/issues/5)

#### 15、[`reset.css` 知多少 ](https://github.com/chokcoco/iCSS/issues/5)

#### 16、[你该知道的字体 `font-family`](https://github.com/chokcoco/iCSS/issues/6)

#### 17、[再探究字体的渲染规则及 fallback 机制](https://github.com/chokcoco/iCSS/issues/7)

#### 18、[使用 `position:sticky` 实现粘性布局](https://github.com/chokcoco/iCSS/issues/8)

#### 19、[深入探讨 CSS 特性检测 @supports 与 Modernizr](https://github.com/chokcoco/iCSS/issues/9)

#### 20、[巧妙地制作背景色渐变动画！](https://github.com/chokcoco/iCSS/issues/10)

如何实现下述的背景色渐变动画？

![lineargradient](https://cloud.githubusercontent.com/assets/8554143/24186346/d984600a-0f12-11e7-8220-dc9a6c04b7ef.gif)

#### 21、[提高 CSS 动画性能的正确姿势](https://github.com/chokcoco/iCSS/issues/11)

#### 22、[纯 CSS 方式实现 CSS 动画的暂停与播放](https://github.com/chokcoco/iCSS/issues/12)

#### 23、[谈谈 CSS 关键字 initial、inherit 和 unset](https://github.com/chokcoco/iCSS/issues/13)

#### 24、使用 `display:flex` 实现瀑布流布局

#### 25、[vh、vw、vmin、vmax 知多少](https://github.com/chokcoco/iCSS/issues/15)

#### 26、[奇妙的`-webkit-background-clip: text`](https://github.com/chokcoco/iCSS/issues/14)

#### 27、[神奇的 `conic-gradient` 圆锥渐变](https://github.com/chokcoco/iCSS/issues/19)

#### 28、[不可思议的混合模式 `mix-blend-mode` ](https://github.com/chokcoco/iCSS/issues/16)

#### 29、[`text-fill-color` 与 `color` 的异同](https://github.com/chokcoco/iCSS/issues/17)

#### 30、[奇妙的 CSS shapes（CSS图形）](https://github.com/chokcoco/iCSS/issues/18)

#### 31、[纯 CSS 实现波浪效果!](https://github.com/chokcoco/iCSS/issues/22)

#### 32、CSS 新特性`contain`，控制页面的重绘与重排

#### 33、[不受控制的 `position:fixed`](https://github.com/chokcoco/iCSS/issues/24)

#### 34、[你所不知道的 CSS 动画技巧与细节](https://github.com/chokcoco/iCSS/issues/27)


[ASDASDSA](#iCSS--!：，interestingcss)


col

# EmbeddingBag

##  产品支持情况

| 产品 | 是否支持 |
| ---- | :----:|
|昇腾910_95 AI处理器|×|
|Atlas A3 训练系列产品/Atlas A3 推理系列产品|√|
|Atlas A2 训练系列产品/Atlas 800I A2 推理产品/A200I A2 Box 异构组件|√|
|Atlas 200I/500 A2推理产品|×|
|Atlas 推理系列产品|√|
|Atlas 训练系列产品|√|
|Atlas 200/300/500 推理产品|×|

## 功能说明

- 算子功能：根据indices从weight中获得一组被聚合的数，然后根据offsets的偏移和mode指定的聚合模式对获取的数进行max、sum、mean聚合。其余参数则更细化了计算过程的控制。
  - shape推导方式如下：
    假设:
    ```
    weight的shape为(numWeight, embeddingDim)
    indices的shape为(indices)
    offsets的shape为(offsets)
    ```
    - 当mode为sum模式：
      ```
      y的shape 为 include_last_offset ? (offsets - 1, embeddingDim) : (offsets, embeddingDim)
      offset2bag的shape 为 (indices,)
      bag_size的shape 为 include_last_offset ? (offsets - 1) : (offsets,)
      max_indices的shape 为 include_last_offset ? (offsets - 1) : (offsets,)
      ```
    - 当mode为mean模式：
      ```
      y的shape 为 include_last_offset? (offsets - 1, embeddingDim) : (offsets, embeddingDim)
      offset2bag的shape 为 (indices,)
      bag_size的shape 为 include_last_offset ? (offsets - 1) : (offsets,)
      max_indices的shape 为 include_last_offset ? (offsets - 1) : (offsets,)
      ```
    - 当mode为max模式：
      ```
      y的shape 为 include_last_offset ? (offsets - 1, embeddingDim) : (offsets, embeddingDim)
      offset2bag的shape 为 (indices,)
      bag_size的shape 为 include_last_offset ? (offsets - 1) : (offsets,)
      max_indices的shape 为 include_last_offset ? (offsets - 1, embeddingDim) : (offsets, embeddingDim)
      ```

## 参数说明

<table style="undefined;table-layout: fixed; width: 1300px"><colgroup>
  <col style="width: 50px">
  <col style="width: 60px">
  <col style="width: 180px">
  <col style="width: 100px">
  <col style="width: 40px">
  </colgroup>
  <thead>
    <tr>
      <th>参数名</th>
      <th>输入/输出/属性</th>
      <th>描述</th>
      <th>数据类型</th>
      <th>数据格式</th>
    </tr></thead>
  <tbody>
    <tr>
      <td>weight</td>
      <td>输入</td>
      <td>词嵌入矩阵，包含所有词的嵌入向量。</td>
      <td>FLOAT、FLOAT16、BFLOAT16</td>
      <td>ND</td>
    </tr>
    <tr>
      <td>indices</td>
      <td>输入</td>
      <td>包含索引的张量，指定要从weight中提取哪些词的嵌入向量。</td>
      <td>INT32、INT64</td>
      <td>ND</td>
    </tr>
    <tr>
      <td>offsets</td>
      <td>可选输入</td>
      <td>用于将indices分割成多个bag的偏移量张量。</td>
      <td>INT32、INT64</td>
      <td>ND</td>
    </tr>
     <tr>
      <td>per_sample_weights</td>
      <td>可选输入</td>
      <td>指定样本权重。</td>
      <td>FLOAT、FLOAT16、BFLOAT16</td>
      <td>ND</td>
    </tr>
     <tr>
      <td>y</td>
      <td>输出</td>
      <td>词嵌入矩阵聚合后的结果。</td>
      <td>INT32、INT64</td>
      <td>ND</td>
    </tr>
    <tr>
      <td>offset2bag</td>
      <td>输出</td>
      <td>bag的起始偏移。</td>
      <td>INT32、INT64</td>
      <td>ND</td>
    </tr>
    <tr>
      <td>bag_size</td>
      <td>输出</td>
      <td>每个bag的大小。</td>
      <td>INT32、INT64</td>
      <td>ND</td>
    </tr>
    <tr>
      <td>max_indices</td>
      <td>输出</td>
      <td>当mode为max时，词嵌入向量最大值所在的行。</td>
      <td>INT32、INT64</td>
      <td>ND</td>
    </tr>
    <tr>
      <td>mode</td>
      <td>可选属性</td>
      <td><ul><li>用于控制聚合模式。</li><li>默认值为"mean"。</li></td>
      <td>String</td>
      <td>-</td>
    </tr>
    <tr>
      <td>scale_grad_by_freq</td>
      <td>可选属性</td>
      <td><ul><li>用于控制是否根据词频缩放梯度。</li><li>默认值为false。</li></td>
      <td>Bool</td>
      <td>-</td>
    </tr>
    <tr>
      <td>sparse</td>
      <td>可选属性</td>
      <td><ul><li>用于控制稀疏模式。</li><li>默认值为false。</li></td>
      <td>Bool</td>
      <td>-</td>
    </tr>
    <tr>
      <td>include_last_offset</td>
      <td>可选属性</td>
      <td><ul><li>控制是否包含最后的偏移。</li><li>默认值为false。</li></td>
      <td>Bool</td>
      <td>-</td>
    </tr>
    <tr>
      <td>padding_idx</td>
      <td>可选属性</td>
      <td><ul><li>控制是否包含最后的偏移。</li><li>默认值为-1。</li></td>
      <td>Int</td>
      <td>-</td>
    </tr>
  </tbody></table>

- Atlas 训练系列产品：不支持BFLOAT16。

## 约束说明

无

## 调用说明

| 调用方式 | 调用样例                                                                   | 说明                                                           |
|--------------|------------------------------------------------------------------------|--------------------------------------------------------------|
| aclnn调用 | [test_aclnn_embedding_bag](./examples/test_aclnn_embedding_bag.cpp) | 通过[aclnnEmbeddingBag](./docs/aclnnEmbeddingBag.md)接口方式调用EmbeddingBag算子。 |
| 图模式调用 | [test_geir_embedding_bag](./examples/test_geir_embedding_bag.cpp)   | 通过[算子IR](./op_graph/embedding_bag_proto.h)构图方式调用EmbeddingBag算子。 |



| 操作          | 耗时                                                         |
| ------------- | ------------------------------------------------------------ |
| Scatter       | $(p-1)(\alpha+\frac np\beta)=(p-1)\alpha+\frac {p-1}p n\beta$  |
| Gather        | $(p-1)(\alpha+\frac np\beta)=(p-1)\alpha+\frac {p-1}p n\beta$     |
| Broadcast     | $(p-1)(\alpha+n\beta)=(p-1)\alpha+ (p-1)n\beta$    |
| Reduce     | $ (p-1)(\alpha+n\beta + n\gamma)=(p-1)\alpha+ (p-1)n\beta +(p-1)n\gamma$                                        |
|  ReduceScatter |  $ (p-1)(\alpha+\frac{n}{p}\beta+\frac{n}{p}\gamma)=(p-1)\alpha+\frac{p-1}{p}n\beta+\frac{p-1}{p}n\gamma $  |
|  AllGather    | $ (p-1)(\alpha+\frac{n}{p}\beta)=(p-1)\alpha+\frac{p-1}{p}n\beta $  |
| AllReduce     | 实现为ReduceScatter +  Allgather: <br> $ 2(p-1)\alpha+2\frac{p-1}{p}n\beta+\frac{p-1}{p}n\gamma $ |






